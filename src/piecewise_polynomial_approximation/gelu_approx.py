
@types.vectorize
def gelu(x):
    """Version2 of general non linear function.

    Args:
        x (Sfixed): the input secret value.
        coeffA (plain-text 2d python list): The plain-text coefficient of specific non-linear functions.
        breaks (plain-text 1d python list): The plain-rext break points of specific functions.

    Returns:
        Sfixed: f(x) value of specific non-lnear function f.
    """
    
    breaks = [-5.0, -2.5, -0.15625, 0.0, 0.01953125, 1.25, 2.5]
    coeffA = [[21637241.45722472, 68339478.65926668, 78708613.41334131, 48309370.15385532, 18105794.9801801, 4376956.6168394, 689380.1904987968, 68625.23338783055, 3932.6943739648, 99.0946360559], [398.81951917105, 8396457.153848283, 6744625.247169217, 187153.91705835552, -721200.9816481877, 526510.3538625687, 605552.3695339034, 217532.08491843968, 36093.32360147488, 2371.34481533081], [0.0, 8390055.269376528, 6725864.676032369, 348117.54909382557, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0, 8389260.179019434, 6694170.216600965, -43789.84169730144, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.52908065885, 8389219.901075643, 6694553.621509801, -7540.22919568308, -1089524.29293078, -73288.53343487886, 269004.795048348, -73066.62589956979, 4600.78572130027, 0.0], [-226883.4244883068, 9608723.762897896, 3838084.344284753, 3775692.796948405, -4143742.2385640405, 1413911.5270641863, -116388.06918775981, -47573.79456002005, 13116.97562769104, -1011.98674583363], [21637240.82024962, -51560953.69882536, 78708611.92673884, -48309369.29038459, 18105794.662724487, -4376956.540248405, 689380.1783747041, -68625.2321736723, 3932.69430415516, -99.09463429934]]
    scaler = [[5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08], [5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08], [5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], [5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0], [5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 1.0], [5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08], [5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08, 5.96e-08]]
    
    m = len(coeffA)
    k = len(coeffA[0])
    degree = k-1
    
    pre_muls = floatingpoint.PreOpL(lambda a,b,_: a * b, [x] * degree)

    poss_res = [0]*m
    for i in range(m):
        poss_res[i] = coeffA[i][0] * scaler[i][0]
        for j in range(degree):
            poss_res[i] += coeffA[i][j+1] * pre_muls[j] * scaler[i][j+1]

    comp = sfix.Array(m)
    for i in range(m):
        comp[i] = (x >= breaks[i])
        
    cipher_index = Array(m, sfix)
    @for_range_opt(m-1)
    def _(i):
        cipher_index[i] = comp[i+regint(1)]
        cipher_index[i] = comp[i]*(comp[i] - cipher_index[i])

    return sfix.dot_product(cipher_index, poss_res)


